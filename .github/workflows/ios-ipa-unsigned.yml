name: Build iOS IPA (unsigned)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_unsigned_ipa:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install xcodegen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Generate Xcode project
        run: |
          cd setup/ios-webview
          /usr/libexec/PlistBuddy -c "Set :StartURL https://proctological-caleb-seminiferous.ngrok-free.dev/ticket.html" Resources/Info.plist
          xcodegen generate

      - name: Build app (no signing)
        run: |
          xcodebuild \
            -project setup/ios-webview/MegaRamIncidenciasiOS.xcodeproj \
            -scheme MegaRamIncidencias \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Package unsigned IPA
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release-iphoneos/Incidencias MegaRam.app"
          mkdir -p build/Payload
          cp -R "${APP_PATH}" build/Payload/
          cd build
          /usr/bin/zip -r MegaRamIncidencias-unsigned.ipa Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: MegaRamIncidencias-unsigned-ipa
          path: build/MegaRamIncidencias-unsigned.ipa
          if-no-files-found: error
