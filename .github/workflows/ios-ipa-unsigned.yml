name: Build iOS IPA (unsigned)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_unsigned_ipa:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install xcodegen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew install xcodegen
          fi

      - name: Generate Xcode project
        run: |
          cd setup/ios-webview
          /usr/libexec/PlistBuddy -c "Set :StartURL https://proctological-caleb-seminiferous.ngrok-free.dev/ticket.html" Resources/Info.plist
          xcodegen generate

      - name: Build app (no signing)
        id: build_app
        run: |
          set +e
          set -o pipefail
          mkdir -p build
          xcodebuild \
            -project setup/ios-webview/MegaRamIncidenciasiOS.xcodeproj \
            -scheme MegaRamIncidencias \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build 2>&1 | tee build/xcodebuild.log
          BUILD_EXIT=${PIPESTATUS[0]}
          if [ "${BUILD_EXIT}" -ne 0 ]; then
            ERROR_LINES=$(grep -E "error:|fatal error:|requires a development team|CodeSign" build/xcodebuild.log | tail -n 25 || true)
            if [ -z "${ERROR_LINES}" ]; then
              ERROR_LINES=$(tail -n 80 build/xcodebuild.log)
            fi
            ERROR_MSG=$(printf "%s" "${ERROR_LINES}" | perl -pe 's/%/%25/g; s/\r/%0D/g; s/\n/%0A/g')
            echo "::error title=xcodebuild failed::${ERROR_MSG}"
          fi
          echo "exit_code=${BUILD_EXIT}" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Package unsigned IPA
        if: steps.build_app.outputs.exit_code == '0'
        run: |
          APP_PATH=$(find build/DerivedData/Build/Products/Release-iphoneos -maxdepth 1 -name "*.app" | head -n 1)
          if [ -z "${APP_PATH}" ]; then
            echo "No se encontro .app compilada"
            exit 1
          fi
          mkdir -p build/Payload
          cp -R "${APP_PATH}" build/Payload/
          cd build
          /usr/bin/zip -r MegaRamIncidencias-unsigned.ipa Payload

      - name: Upload IPA artifact
        if: steps.build_app.outputs.exit_code == '0'
        uses: actions/upload-artifact@v4
        with:
          name: MegaRamIncidencias-unsigned-ipa
          path: build/MegaRamIncidencias-unsigned.ipa
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build/xcodebuild.log
          if-no-files-found: warn

      - name: Fail if build failed
        if: steps.build_app.outputs.exit_code != '0'
        run: |
          echo "xcodebuild fallo con exit code ${{ steps.build_app.outputs.exit_code }}. Revisa el artifact build-logs."
          exit 1
